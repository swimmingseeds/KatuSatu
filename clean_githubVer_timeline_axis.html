<!-- Styles -->
<meta charset="utf-8">

<style>
#chartdiv {
  width: 100%;
  height: 500px;
}

</style>

<!-- Resources -->
<script src="https://www.amcharts.com/lib/4/core.js"></script>
<script src="https://www.amcharts.com/lib/4/charts.js"></script>
<script src="https://www.amcharts.com/lib/4/themes/animated.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

<!-- Chart code -->
<script>

var CSV = {
parse: function(csv, reviver) {
    reviver = reviver || function(r, c, v) { return v; };
    var chars = csv.split(''), c = 0, cc = chars.length, start, end, table = [], row;
    while (c < cc) {
        table.push(row = []);
        while (c < cc && '\r' !== chars[c] && '\n' !== chars[c]) {
            start = end = c;
            if ('"' === chars[c]){
                start = end = ++c;
                while (c < cc) {
                    if ('"' === chars[c]) {
                        if ('"' !== chars[c+1]) { break; }
                        else { chars[++c] = ''; } // unescape ""
                    }
                    end = ++c;
                }
                if ('"' === chars[c]) { ++c; }
                while (c < cc && '\r' !== chars[c] && '\n' !== chars[c] && ',' !== chars[c]) { ++c; }
            } else {
                while (c < cc && '\r' !== chars[c] && '\n' !== chars[c] && ',' !== chars[c]) { end = ++c; }
            }
            row.push(reviver(table.length-1, row.length, chars.slice(start, end).join('')));
            if (',' === chars[c]) { ++c; }
        }
        if ('\r' === chars[c]) { ++c; }
        if ('\n' === chars[c]) { ++c; }
    }
    return table;
},

stringify: function(table, replacer) {
    replacer = replacer || function(r, c, v) { return v; };
    var csv = '', c, cc, r, rr = table.length, cell;
    for (r = 0; r < rr; ++r) {
        if (r) { csv += '\r\n'; }
        for (c = 0, cc = table[r].length; c < cc; ++c) {
            if (c) { csv += ','; }
            cell = replacer(r, c, table[r][c]);
            if (/[,\r\n"]/.test(cell)) { cell = '"' + cell.replace(/"/g, '""') + '"'; }
            csv += (cell || 0 === cell) ? cell : '';
        }
    }
    return csv;
}
};

$(document).ready(function() {
    $.ajax({
        type: "GET",
        url: "./data.csv",
        dataType: "text",
        success: function(data) {processData(data);}
     });
});

function processData(text) {
  var parsed = CSV.parse(text);
  graphIt("rawLineGraph", "신청자수", parsed);

  var hourDiff = [];
  hourDiff.push(parsed[0]);//first Row. Header.
  for(var i=2; i<parsed.length; i++) {
    var diffRow = [];
    diffRow.push(parsed[i][0]);
    for(var j=1; j<12; j++) {
      diffRow.push(parsed[i][j] - parsed[i-1][j]);
    }
    hourDiff.push(diffRow);
  }//for each row.
  graphIt("hourDiffLineGraph", "1시간당 신청자수", hourDiff);
}

function graphIt(divName, title, data_) {
  am4core.ready(function() {

  am4core.useTheme(am4themes_animated);

  var chart = am4core.create(divName, am4charts.XYChart);

  var data = [];
  for (var i = 1; i < data_.length; i++) {
    data.push({ DateTime: new Date(data_[i][0]), month_2: data_[i][1], month_3: data_[i][2], month_4: data_[i][3], month_5: data_[i][4], month_6: data_[i][5], month_7: data_[i][6], month_8: data_[i][7], month_9: data_[i][8], month_10: data_[i][9], month_11: data_[i][10], month_12: data_[i][11] });
  }

  chart.data = data;

  var dateAxis = chart.xAxes.push(new am4charts.DateAxis());
  dateAxis.renderer.grid.template.location = 0;
  dateAxis.renderer.labels.template.fill = am4core.color("#e59165");


  var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());
  valueAxis.tooltip.disabled = true;
  valueAxis.renderer.labels.template.fill = am4core.color("#e59165");

  valueAxis.renderer.minWidth = 60;


  for(var i=0; i<11; i++) {
    var series = chart.series.push(new am4charts.LineSeries());
    series.name = String(i + 2) + "월";
    series.dataFields.dateX = "DateTime";
    series.dataFields.valueY = "month_" + String(i + 2);
    series.tooltipText = "{name}: {valueY.value}";
    series.stacked = true;
  }

  chart.cursor = new am4charts.XYCursor();
  chart.cursor.xAxis = dateAxis;

  chart.legend = new am4charts.Legend();
  chart.legend.parent = chart.plotContainer;
  chart.legend.zIndex = 100;

  dateAxis.renderer.grid.template.strokeOpacity = 0.07;
  valueAxis.renderer.grid.template.strokeOpacity = 0.07;

  chart.tapToActivate = true;

  }); 
}
</script>

<!-- HTML -->
<div id="rawLineGraph" style="width: 80%; height: 400px;"></div>
<div id="hourDiffLineGraph"></div>